services:
  traefik:
    image: traefik:v3.1
    restart: unless-stopped
    command:
      - "--log.level=INFO"
      - "--providers.docker=true"
      - "--providers.file.filename=/dynamic.yml"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.email=${TRAEFIK_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    ports:
      - "80:80"
      - "8443:443"
    environment:
      - TZ=${TZ}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /srv/volumes/traefik/letsencrypt:/letsencrypt
      - ./docker/traefik/traefik.yml:/traefik.yml:ro
      - ./docker/traefik/dynamic.yml:/dynamic.yml:ro
    labels:
      - "traefik.enable=true"

      # Dashboard on HTTPS at traefik domain
      - "traefik.http.routers.api.rule=Host(`${TRAEFIK_DOMAIN_TRAEFIK}`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.api.service=api@internal"

      # Basic auth for dashboard
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_DASHBOARD_USER}:${TRAEFIK_DASHBOARD_PASS_HASH}"
      - "traefik.http.routers.api.middlewares=auth,secure-headers@file"

      # Optional HTTP -> HTTPS redirect for the dashboard host
      - "traefik.http.routers.api-http.rule=Host(`${TRAEFIK_DOMAIN_TRAEFIK}`)"
      - "traefik.http.routers.api-http.entrypoints=web"
      - "traefik.http.routers.api-http.middlewares=redirect-to-https@file"

  mariadb:
    image: mariadb:11.4
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
    volumes:
      - /srv/volumes/mariadb/data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 10

  db-init:
    image: mariadb:11.4
    depends_on:
      mariadb:
        condition: service_healthy
    environment:
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MARIADB_NEXTCLOUD_DB=${MARIADB_NEXTCLOUD_DB}
      - MARIADB_NEXTCLOUD_USER=${MARIADB_NEXTCLOUD_USER}
      - MARIADB_NEXTCLOUD_PASSWORD=${MARIADB_NEXTCLOUD_PASSWORD}
      - MARIADB_MATOMO_DB=${MARIADB_MATOMO_DB}
      - MARIADB_MATOMO_USER=${MARIADB_MATOMO_USER}
      - MARIADB_MATOMO_PASSWORD=${MARIADB_MATOMO_PASSWORD}
    entrypoint: ["/bin/sh", "-lc"]
    command: |
      mariadb -h mariadb -P3306 -u root -p"$MARIADB_ROOT_PASSWORD" <<SQL
      CREATE DATABASE IF NOT EXISTS \`${MARIADB_NEXTCLOUD_DB}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
      CREATE USER IF NOT EXISTS '${MARIADB_NEXTCLOUD_USER}'@'%' IDENTIFIED BY '${MARIADB_NEXTCLOUD_PASSWORD}';
      GRANT ALL PRIVILEGES ON \`${MARIADB_NEXTCLOUD_DB}\`.* TO '${MARIADB_NEXTCLOUD_USER}'@'%';

      CREATE DATABASE IF NOT EXISTS \`${MARIADB_MATOMO_DB}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
      CREATE USER IF NOT EXISTS '${MARIADB_MATOMO_USER}'@'%' IDENTIFIED BY '${MARIADB_MATOMO_PASSWORD}';
      GRANT ALL PRIVILEGES ON \`${MARIADB_MATOMO_DB}\`.* TO '${MARIADB_MATOMO_USER}'@'%';

      FLUSH PRIVILEGES;
      SQL
    restart: "no"

  redis:
    image: redis:7
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - /srv/volumes/redis/data:/data

  nextcloud:
    image: nextcloud:28-apache
    restart: unless-stopped
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      - TZ=${TZ}
      - MYSQL_HOST=mariadb
      - MYSQL_DATABASE=${MARIADB_NEXTCLOUD_DB}
      - MYSQL_USER=${MARIADB_NEXTCLOUD_USER}
      - MYSQL_PASSWORD=${MARIADB_NEXTCLOUD_PASSWORD}
      - REDIS_HOST=redis
      - NEXTCLOUD_TRUSTED_DOMAINS=${NEXTCLOUD_TRUSTED_DOMAINS}
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - PHP_MEMORY_LIMIT=1024M
      - PHP_UPLOAD_LIMIT=${NEXTCLOUD_UPLOAD_LIMIT}
    volumes:
      - /srv/volumes/nextcloud/html:/var/www/html
      - /srv/volumes/nextcloud/data:/var/www/html/data
      - ./docker/nextcloud/php.ini:/usr/local/etc/php/conf.d/zz-custom.ini:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`${NEXTCLOUD_DOMAIN}`)"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.tls.certresolver=letsencrypt"
      # well-known redirects for caldav/carddav
      - "traefik.http.middlewares.nc-redirect.redirectregex.regex=^https?://(.*)/.well-known/(card|cal)dav"
      - "traefik.http.middlewares.nc-redirect.redirectregex.replacement=https://$${1}/remote.php/dav/"
      - "traefik.http.routers.nextcloud.middlewares=nc-redirect,secure-headers@file"
      # HTTP â†’ HTTPS
      - "traefik.http.routers.nextcloud-http.rule=Host(`${NEXTCLOUD_DOMAIN}`)"
      - "traefik.http.routers.nextcloud-http.entrypoints=web"
      - "traefik.http.routers.nextcloud-http.middlewares=redirect-to-https@file"

  nextcloud-cron:
    image: nextcloud:28-apache
    restart: unless-stopped
    entrypoint: /cron.sh
    depends_on:
      - nextcloud
    volumes:
      - /srv/volumes/nextcloud/html:/var/www/html
      - /srv/volumes/nextcloud/data:/var/www/html/data

  matomo:
    image: matomo:apache
    restart: unless-stopped
    depends_on:
      mariadb:
        condition: service_healthy
    environment:
      - TZ=${TZ}
      - MATOMO_DATABASE_HOST=mariadb
      - MATOMO_DATABASE_ADAPTER=MYSQLI
      - MATOMO_DATABASE_TABLES_PREFIX=matomo_
      - MATOMO_DATABASE_USERNAME=${MARIADB_MATOMO_USER}
      - MATOMO_DATABASE_PASSWORD=${MARIADB_MATOMO_PASSWORD}
      - MATOMO_DATABASE_DBNAME=${MARIADB_MATOMO_DB}
    volumes:
      - /srv/volumes/matomo/html:/var/www/html
      - ./docker/matomo/php.ini:/usr/local/etc/php/conf.d/zz-custom.ini:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.matomo.rule=Host(`${MATOMO_DOMAIN}`)"
      - "traefik.http.routers.matomo.entrypoints=websecure"
      - "traefik.http.routers.matomo.tls.certresolver=letsencrypt"
      - "traefik.http.routers.matomo.middlewares=secure-headers@file"
      - "traefik.http.routers.matomo-http.rule=Host(`${MATOMO_DOMAIN}`)"
      - "traefik.http.routers.matomo-http.entrypoints=web"
      - "traefik.http.routers.matomo-http.middlewares=redirect-to-https@file"

  matomo-cron:
    image: matomo:apache
    restart: unless-stopped
    depends_on:
      - matomo
    entrypoint:
      [
        "/bin/bash",
        "-lc",
        "while true; do sudo -u www-data php /var/www/html/console core:archive
        --url=https://${MATOMO_DOMAIN} --concurrent-archivers=1; sleep 300; done",
      ]
    volumes:
      - /srv/volumes/matomo/html:/var/www/html
networks:
  default:
    name: web
